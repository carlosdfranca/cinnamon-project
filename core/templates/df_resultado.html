{% extends 'base/base.html' %}
{% load static %}
{% load custom_tags %}

{% block title %}Demonstração Financeira{% endblock %}

{% block conteudo %}
<!-- Navbar -->
{% include 'base/navbar.html' %}

<div class="container mt-4">
  <div class="card shadow rounded p-4">

    <!-- Cabeçalho -->

    <div class="row mb-4">
      <div class="col-md-9">
        <div class="fw-bold" style="font-size: 1.05rem;">
          {{ fundo.nome|upper }}
        </div>
        <div class="fw-bold">
          CNPJ: {{ fundo.cnpj }}
        </div>
        <div class="mt-2">
          {{ fundo.empresa.nome }}
        </div>
        <div>
          CNPJ: {{ fundo.empresa.cnpj }}
        </div>
      </div>
      <div class="col-md-3 text-end">
        <a href="{% url 'exportar_dre_excel' fundo.id ano %}" class="btn btn-success">Baixar Demonstração Financeira <i class="bi bi-file-earmark-excel-fill ms-2"></i></a>
      </div>
    </div>

    <ul class="nav nav-tabs d-flex" id="myTabjustified" role="tablist">
      <li class="nav-item flex-fill" role="presentation">
        <button class="nav-link w-100 active" id="dpf-tab" data-bs-toggle="tab" data-bs-target="#dpf-justified" type="button" role="tab" aria-controls="dpf" aria-selected="true">DPF</button>
      </li>
      <li class="nav-item flex-fill" role="presentation">
        <button class="nav-link w-100" id="dre-tab" data-bs-toggle="tab" data-bs-target="#dre-justified" type="button" role="tab" aria-controls="dre" aria-selected="false">DRE</button>
      </li>
      <li class="nav-item flex-fill" role="presentation">
        <button class="nav-link w-100" id="dmpl-tab" data-bs-toggle="tab" data-bs-target="#dmpl-justified" type="button" role="tab" aria-controls="dmpl" aria-selected="false">DMPL</button>
      </li>
      <li class="nav-item flex-fill" role="presentation">
        <button class="nav-link w-100" id="dfc-tab" data-bs-toggle="tab" data-bs-target="#dfc-justified" type="button" role="tab" aria-controls="dfc" aria-selected="false">DFC</button>
      </li>
    </ul>
    <div class="tab-content pt-2" id="myTabjustifiedContent">
      <!-- DPF -->
      <div class="tab-pane fade show active" id="dpf-justified" role="tabpanel" aria-labelledby="dpf-tab">
        <div class="fw-bold mt-3">
          Demonstração da Posição Financeira
        </div>
        <div class="fw-bold">
          Em 31 de dezembro de {{ ano }} e {{ ano|add:"-1" }}
        </div>
        <div class="fst-italic" style="font-size: 0.85rem;">
          (Valores expressos em milhares de reais, exceto quando apresentado de outra forma)											
        </div>
        
        <!-- Tabela com os dados do DPF-->         
        <table class="table table-bordered table-sm mt-2">
          <thead class="table-light">
            <tr>
              <th style="width: 60%">Descrição</th>
              <th style="width: 10%" class="text-end">31/12/{{ ano }}</th>
              <th style="width: 10%" class="text-end">% PL {{ ano }}</th>
              <th style="width: 10%" class="text-end">31/12/{{ ano|add:"-1" }}</th>
              <th style="width: 10%" class="text-end">% PL {{ ano|add:"-1" }}</th>
            </tr>
          </thead>
          <tbody>

            {# ====== ATIVO ====== #}
            {% with secao=dpf_tabela.ATIVO %}
              {% for grupo_label, bloco in secao.items %}
                {% if grupo_label|slice:":6" != "TOTAL_" and grupo_label|slice:":5" != "PERC_" %}
                  <tr class="table-secondary fw-bold">
                    <td colspan="1">{{ grupo_label }}</td>
                    <td class="text-end">{{ bloco.SOMA|default:0|formata_milhar }}</td>
                    <td class="text-end">{{ bloco.PERC_ATUAL|default:0|formata_milhar }}</td>
                    <td class="text-end">{{ bloco.SOMA_ANTERIOR|default:0|formata_milhar }}</td>
                    <td class="text-end">{{ bloco.PERC_ANTERIOR|default:0|formata_milhar }}</td>
                  </tr>

                  {% for subgrupo, valores in bloco.items %}
                    {% if subgrupo not in 'SOMA,SOMA_ANTERIOR,PERC_ATUAL,PERC_ANTERIOR' %}
                      <tr>
                        <td>{{ subgrupo }}</td>
                        <td class="text-end">{{ valores.ATUAL|default:0|formata_milhar }}</td>
                        <td class="text-end">{{ valores.PERC_ATUAL|default:0|formata_milhar }}</td>
                        <td class="text-end">{{ valores.ANTERIOR|default:0|formata_milhar }}</td>
                        <td class="text-end">{{ valores.PERC_ANTERIOR|default:0|formata_milhar }}</td>
                      </tr>
                    {% endif %}
                  {% endfor %}

                  <tr class="border-top">
                    <td colspan="5" style="background-color: #F7F3E3; border-left: none; border-right: none;"></td>
                  </tr>
                {% endif %}
              {% endfor %}

              <!-- TOTAL ATIVO -->
              <tr class="table-secondary fw-bold">
                <td>TOTAL ATIVO</td>
                <td class="text-end">{{ secao.TOTAL_ATIVO.ATUAL|default:0|formata_milhar }}</td>
                <td class="text-end">{{ secao.TOTAL_ATIVO.PERC_ATUAL|default:0|formata_milhar }}</td>
                <td class="text-end">{{ secao.TOTAL_ATIVO.ANTERIOR|default:0|formata_milhar }}</td>
                <td class="text-end">{{ secao.TOTAL_ATIVO.PERC_ANTERIOR|default:0|formata_milhar }}</td>
              </tr>
            {% endwith %}

            <!-- Separador entre seções -->
            <tr class="border-top">
              <td colspan="5" style="background-color: #F7F3E3; border-left: none; border-right: none;"></td>
            </tr>

            {# ====== PASSIVO ====== #}
            {% with secao=dpf_tabela.PASSIVO %}
              {% for grupo_label, bloco in secao.items %}
                {% if grupo_label|slice:":6" != "TOTAL_" and grupo_label|slice:":5" != "PERC_" %}
                  <tr class="table-secondary fw-bold">
                    <td colspan="1">{{ grupo_label }}</td>
                    <td class="text-end">{{ bloco.SOMA|default:0|formata_milhar }}</td>
                    <td class="text-end">{{ bloco.PERC_ATUAL|default:0|formata_milhar }}</td>
                    <td class="text-end">{{ bloco.SOMA_ANTERIOR|default:0|formata_milhar }}</td>
                    <td class="text-end">{{ bloco.PERC_ANTERIOR|default:0|formata_milhar }}</td>
                  </tr>

                  {% for subgrupo, valores in bloco.items %}
                    {% if subgrupo not in 'SOMA,SOMA_ANTERIOR,PERC_ATUAL,PERC_ANTERIOR' %}
                      <tr>
                        <td>{{ subgrupo }}</td>
                        <td class="text-end">{{ valores.ATUAL|default:0|formata_milhar }}</td>
                        <td class="text-end">{{ valores.PERC_ATUAL|default:0|formata_milhar }}</td>
                        <td class="text-end">{{ valores.ANTERIOR|default:0|formata_milhar }}</td>
                        <td class="text-end">{{ valores.PERC_ANTERIOR|default:0|formata_milhar }}</td>
                      </tr>
                    {% endif %}
                  {% endfor %}

                  <tr class="border-top">
                    <td colspan="5" style="background-color: #F7F3E3; border-left: none; border-right: none;"></td>
                  </tr>
                {% endif %}
              {% endfor %}

              <!-- TOTAL PASSIVO -->
              <tr class="table-secondary fw-bold">
                <td>TOTAL PASSIVO</td>
                <td class="text-end">{{ secao.TOTAL_PASSIVO.ATUAL|default:0|formata_milhar }}</td>
                <td class="text-end">{{ secao.TOTAL_PASSIVO.PERC_ATUAL|default:0|formata_milhar }}</td>
                <td class="text-end">{{ secao.TOTAL_PASSIVO.ANTERIOR|default:0|formata_milhar }}</td>
                <td class="text-end">{{ secao.TOTAL_PASSIVO.PERC_ANTERIOR|default:0|formata_milhar }}</td>
              </tr>
            {% endwith %}

            <!-- Separador entre seções -->
            <tr class="border-top">
              <td colspan="5" style="background-color: #F7F3E3; border-left: none; border-right: none;"></td>
            </tr>

            <!-- PL -->
            <tr class="table-secondary fw-bold">
              <td>Patrimônio líquido</td>
              <td class="text-end">{{ pl_ajustado_atual|formata_milhar }}</td>
              <td class="text-end">-</td>
              <td class="text-end">{{ pl_ajustado_anterior|formata_milhar }}</td>
              <td class="text-end">-</td>
            </tr>

            <!-- Separador entre seções -->
            <tr class="border-top">
              <td colspan="5" style="background-color: #F7F3E3; border-left: none; border-right: none;"></td>
            </tr>

            <!-- PL + PASSIVO -->
            <tr class="table-secondary fw-bold">
              <td>Total do patrimônio líquido e do passivo</td>
              <td class="text-end">{{ total_pl_passivo_atual|formata_milhar }}</td>
              <td class="text-end">{{ perc_total_pl_passivo_atual|formata_milhar }}</td>
              <td class="text-end">{{ total_pl_passivo_anterior|formata_milhar }}</td>
              <td class="text-end">{{ perc_total_pl_passivo_anterior|formata_milhar }}</td>
            </tr>

          </tbody>
        </table>
      </div>

      <!-- DRE -->
      <div class="tab-pane fade" id="dre-justified" role="tabpanel" aria-labelledby="dre-tab">
        <div class="fw-bold mt-3">
          Demonstração do Resultado do Exercício
        </div>
        <div class="fw-bold">
          Exercícios findos em 31 de dezembro de {{ ano }} e {{ ano|add:"-1" }}
        </div>
        <div class="fst-italic" style="font-size: 0.85rem;">
          (Valores expressos em milhares de reais)
        </div>

        <!-- Tabela com os dados do DRE-->
        <table class="table table-bordered table-sm mt-2">
          <thead class="table-light">
            <tr>
              <th style="width: 80%">Descrição</th>
              <th style="width: 10%" class="text-end">31/12/{{ ano }}</th>
              <th style="width: 10%" class="text-end">31/12/{{ ano|add:"-1" }}</th>
            </tr>
          </thead>
          <tbody>
            {% for grupo, valores in dre_tabela.items %}
              <tr class="table-secondary fw-bold">
                <td colspan="1">{{ grupo }}</td>
                <td class="text-end">{{ valores.SOMA|formata_milhar }}</td>
                <td class="text-end">{{ valores.SOMA_ANTERIOR|formata_milhar }}</td>
              </tr>
              {% for subgrupo, val in valores.items %}
                {% if subgrupo != 'SOMA' and subgrupo != 'SOMA_ANTERIOR' %}
                  <tr>
                    <td>{{ subgrupo }}</td>
                    <td class="text-end">{{ val.ATUAL|formata_milhar }}</td>
                    <td class="text-end">{{ val.ANTERIOR|formata_milhar }}</td>
                  </tr>
                {% endif %}
              {% endfor %}

              <tr class="border-top">
                <td colspan="3" style="background-color: #F7F3E3; border-left: none; border-right: none;"></td>
              </tr>

            {% endfor %}

            <!-- Resultado do exercício -->
            <tr class="table-secondary fw-bold">
              <td>Resultado do exercício</td>
              <td class="text-end">{{ resultado_exercicio|formata_milhar }}</td>
              <td class="text-end">{{ resultado_exercicio_anterior|formata_milhar }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- DMPL -->
      <div class="tab-pane fade" id="dmpl-justified" role="tabpanel" aria-labelledby="dmpl-tab">
        <div class="fw-bold mt-3">
          Demonstração das Mutações do Patrimônio Líquido 
        </div>
        <div class="fw-bold">
          Exercícios findos em 31 de dezembro de {{ ano }} e {{ ano|add:"-1" }}
        </div>
        <div class="fst-italic" style="font-size: 0.85rem;">
           (Valores expressos em milhares de reais, exceto o valor unitário do valor da cota)
        </div>

        <table class="table table-bordered table-sm mt-2">
          <thead class="table-light">
            <tr>
              <th style="width: 80%">Descrição</th>
              <th style="width: 10%" class="text-end">31/12/{{ ano }}</th>
              <th style="width: 10%" class="text-end">31/12/{{ ano|add:"-1" }}</th>
            </tr>
          </thead>
          <tbody>
            <tr class="table-secondary fw-bold">
              <td colspan="1">Patrimônio líquido no início do período</td>
              <td class="text-end">{{ dados_dmpl.valor_primeiro|formata_milhar }}</td>
              <td class="text-end">{{ dados_dmpl.valor_primeiro_ant|formata_milhar }}</td>
            </tr>
            <tr>
              <td>Total de <strong>{{ dados_dmpl.qtd_cotas_inicio|formata_milhar }}</strong> cotas subordinadas a <strong>R${{ dados_dmpl.cota_inicio|formata_milhar }}</strong></td>
              <td class="text-end">{{ dados_dmpl.valor_primeiro|formata_milhar }}</td>
              <td class="text-end">-</td>
            </tr>
            <tr>
              <td>Total de <strong>{{ dados_dmpl.qtd_cotas_inicio_ant|formata_milhar }}</strong> cotas subordinadas a <strong>R${{ dados_dmpl.cota_inicio_ant|formata_milhar }}</strong></td>
              <td class="text-end">-</td>
              <td class="text-end">{{ dados_dmpl.valor_primeiro_ant|formata_milhar }}</td>
            </tr>
            <!-- PULA LINHA -->
            <tr class="border-top">
              <td colspan="3" style="background-color: #F7F3E3; border-left: none; border-right: none;"></td>
            </tr>

            <tr class="table-secondary fw-bold">
              <td colspan="3">Emissão de cotas</td>
            </tr>
            <tr>
              <td> Total de <strong>{{ dados_dmpl.aplicacoes_qtd|formata_milhar }}</strong> cotas subordinadas</td>
              <td class="text-end">{{ dados_dmpl.aplicacoes_valor|formata_milhar }}</td>
              <td class="text-end">{{ dados_dmpl.aplicacoes_valor_ant|formata_milhar }}</td>
            </tr>
            <!-- PULA LINHA -->
            <tr class="border-top">
              <td colspan="3" style="background-color: #F7F3E3; border-left: none; border-right: none;"></td>
            </tr>

            <tr class="table-secondary fw-bold">
              <td colspan="3">Resgate de cotas</td>
            </tr>
            <tr>
              <td> Total de <strong>{{ dados_dmpl.resgates_qtd|formata_milhar }}</strong> cotas subordinadas</td>
              <td class="text-end">{{ dados_dmpl.resgates_valor|formata_milhar }}</td>
              <td class="text-end">{{ dados_dmpl.resgates_valor_ant|formata_milhar }}</td>
            </tr>
            <!-- PULA LINHA -->
            <tr class="border-top">
              <td colspan="3" style="background-color: #F7F3E3; border-left: none; border-right: none;"></td>
            </tr>

            <tr class="table-secondary fw-bold">
              <td colspan="1">Patrimônio líquido antes do resultado do período</td>
              <td class="text-end">{{ dados_dmpl.valor_primeiro|formata_milhar }}</td>
              <td class="text-end">{{ dados_dmpl.valor_primeiro_ant|formata_milhar }}</td>
            </tr>
            <tr class="border-top">
              <td colspan="3" style="background-color: #F7F3E3; border-left: none; border-right: none;"></td>
            </tr>

            <tr class="table-secondary fw-bold">
              <td colspan="1">Resultado do período</td>
              <td class="text-end">{{ resultado_exercicio|formata_milhar }}</td>
              <td class="text-end">{{ resultado_exercicio_anterior|formata_milhar }}</td>
            </tr>
            <tr class="border-top">
              <td colspan="3" style="background-color: #F7F3E3; border-left: none; border-right: none;"></td>
            </tr>
            
            <tr class="table-secondary fw-bold">
              <td colspan="1">Patrimônio líquido no final do exercício/período</td>
              <td class="text-end">{{ pl_ajustado_atual|formata_milhar }}</td>
              <td class="text-end">{{ pl_ajustado_anterior|formata_milhar }}</td>
            </tr>
            <tr>
              <td>Total de <strong>{{ dados_dmpl.qtd_cotas_fim|formata_milhar }}</strong> cotas subordinadas a <strong>R${{ dados_dmpl.cota_fim|formata_milhar }}</strong></td>
              <td class="text-end">{{ dados_dmpl.valor_ultimo|formata_milhar }}</td>
              <td class="text-end">-</td>
            </tr>
            <tr>
              <td>Total de <strong>{{ dados_dmpl.qtd_cotas_inicio|formata_milhar }}</strong> cotas subordinadas a <strong>R${{ dados_dmpl.cota_inicio|formata_milhar }}</strong></td>
              <td class="text-end">-</td>
              <td class="text-end">{{ dados_dmpl.valor_primeiro|formata_milhar }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- DFC -->
      <div class="tab-pane fade" id="dfc-justified" role="tabpanel" aria-labelledby="dfc-tab">
        Saepe animi et soluta ad odit soluta sunt. Nihil quos omnis animi debitis cumque. Accusantium quibusdam perspiciatis qui qui omnis magnam. Officiis accusamus impedit molestias nostrum veniam. Qui amet ipsum iure. Dignissimos fuga tempore dolor.
      </div>
    </div>
  </div>
</div>
{% endblock %}
